# AWS CloudFormation: Private EC2 with SSM & ALB

プライベートサブネット内のEC2インスタンスに対し、踏み台サーバーやNAT Gatewayを使用せず、VPCエンドポイント経由でセキュアにSSM（セッションマネージャー）接続を行うCloudFormationテンプレートです。
また、外部からのHTTPアクセスを受け付けるALB（Application Load Balancer）も構築します。

## ⚠️ 本テンプレートの利用に関する注意事項 (学習用)

**本テンプレートは、AWSのネットワーク構成やSSM接続の仕組みを理解するための「学習用」として作成されています。**

## 🏗 アーキテクチャ概要

* **VPC**: 10.0.0.0/16
* **Public Subnet**: ALB配置用。
* **Private Subnet**: EC2インスタンスおよびVPCエンドポイント配置用。インターネットへの直接アクセス不可。
* **VPC Endpoints (Interface型)**: `ssm`, `ssmmessages`, `ec2messages`。SSM接続のためにプライベートサブネット内にENIを作成。
* **VPC Endpoint (Gateway型)**: `s3`。Amazon Linuxのリポジトリ参照やSSMエージェントの更新用。
* **Security Groups**:
    * ALB用: HTTP(80)を全開放。
    * EC2用: ALBからの8080と、VPCエンドポイントからの443のみ許可（循環参照回避のためルールを分離定義）。
    * Endpoint用: EC2からの443のみ許可。

## 🚀 デプロイ方法

1.  **AWSマネジメントコンソール**にログインし、CloudFormationサービスへ移動します。
2.  「スタックの作成」→「新しいリソースを使用 (標準)」を選択します。
3.  `template.yaml` (本リポジトリのテンプレートファイル) をアップロードします。
4.  スタック名（例: `ssm-study-stack`）を入力し、パラメータはデフォルトまたは任意で設定して進みます。
5.  「IAMリソースの作成承認」にチェックを入れて「送信」をクリックします。
6.  ステータスが `CREATE_COMPLETE` になるまで待ちます（約3〜5分）。

## 💻 接続方法 (Session Manager)

EC2はプライベートサブネットにあり、Public IPを持っていませんが、SSM経由でブラウザからシェル接続が可能です。

1.  **EC2コンソール**へ移動します。
2.  作成されたインスタンス (`aws-study-ec2`) を選択します。
3.  **「接続」**ボタンをクリックし、**「セッションマネージャー」**タブを選択します。
4.  「接続」ボタンをクリックするとターミナルが開きます。

## 🔐 セキュリティ設定のポイント

このテンプレートでは、以下のセキュリティベストプラクティスを採用しています。

* **No Public SSH**: SSHポート(22)は開放していません。
* **No NAT Gateway**: コスト削減とセキュリティ向上のため、NAT Gatewayを使用せずVPCエンドポイントのみで構成しています。
* **Strict Egress Rules**: EC2のアウトバウンド（送信）通信は、VPC内部へのHTTPS(443)のみに制限しています。万が一のマルウェア感染時でも、外部C&Cサーバーへの通信をブロックします。
* **Circular Dependency Resolution**: セキュリティグループの相互参照による循環依存エラーを防ぐため、SG本体とインルール定義をリソースとして分離しています。

## 🧹 リソースの削除

1.  CloudFormationコンソールへ移動。
2.  対象のスタックを選択し、「削除」をクリック。
3.  全リソースが削除されたことを確認します。